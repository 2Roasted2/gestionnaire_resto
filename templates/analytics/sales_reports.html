{% extends 'base.html' %}

{% block title %}Rapports Ventes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">
                <i class="fas fa-shopping-cart"></i> Rapports de Ventes
            </h1>
            <p class="lead text-muted">Analyse des commandes et ventes (30 derniers jours)</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'analytics:dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour au dashboard
            </a>
        </div>
    </div>

    <div class="row g-3">
        <!-- Ventes par type de commande -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Ventes par type de commande</h5>
                </div>
                <div class="card-body">
                    <canvas id="orderTypeChart"></canvas>
                    <hr>
                    <div class="mt-3">
                        {% for type in sales_by_type %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>
                                <span class="badge bg-{% if type.order_type == 'DINE_IN' %}primary{% elif type.order_type == 'TAKEAWAY' %}warning{% else %}info{% endif %}">
                                    {{ type.order_type }}
                                </span>
                            </span>
                            <div>
                                <span class="badge bg-secondary">{{ type.count }} commandes</span>
                                <strong class="ms-2">{{ type.total_revenue|floatformat:0 }} €</strong>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted mb-0">Aucune donnée disponible</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Évolution quotidienne (7 jours) -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Évolution quotidienne (7 derniers jours)</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top 20 plats vendus -->
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-fire"></i> Top 20 - Plats les plus vendus</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Plat</th>
                                    <th>Catégorie</th>
                                    <th class="text-end">Quantité vendue</th>
                                    <th class="text-end">Revenus générés</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_selling_items %}
                                <tr>
                                    <td><strong>{{ forloop.counter }}</strong></td>
                                    <td>{{ item.menu_item__name }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ item.menu_item__category__name }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ item.total_quantity }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ item.total_revenue|floatformat:2 }} €</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Aucune donnée disponible</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ventes par catégorie de menu -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-layer-group"></i> Ventes par catégorie de menu</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Performances par serveur -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-award"></i> Top 10 - Performances par serveur</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Serveur</th>
                                    <th class="text-end">Commandes</th>
                                    <th class="text-end">Revenus</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for waiter in sales_by_waiter %}
                                <tr>
                                    <td><strong>{{ forloop.counter }}</strong></td>
                                    <td>{{ waiter.served_by__first_name }} {{ waiter.served_by__last_name }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ waiter.orders_count }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ waiter.total_revenue|floatformat:0 }} €</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Aucune donnée disponible</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Graphique par type de commande
const typeData = {{ sales_by_type|safe }};
const typeCtx = document.getElementById('orderTypeChart').getContext('2d');
new Chart(typeCtx, {
    type: 'doughnut',
    data: {
        labels: typeData.map(t => t.order_type),
        datasets: [{
            data: typeData.map(t => t.total_revenue),
            backgroundColor: [
                'rgba(13, 110, 253, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(13, 202, 240, 0.7)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Graphique évolution quotidienne
const dailyData = {{ daily_sales|safe }};
const dailyCtx = document.getElementById('dailySalesChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dailyData.map(d => d.date),
        datasets: [
            {
                label: 'Revenus (€)',
                data: dailyData.map(d => d.revenue),
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                yAxisID: 'y',
                tension: 0.4,
                fill: true
            },
            {
                label: 'Nombre de commandes',
                data: dailyData.map(d => d.orders),
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                yAxisID: 'y1',
                tension: 0.4,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + ' €';
                    }
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false
                }
            }
        }
    }
});

// Graphique par catégorie
const categoryData = {{ sales_by_category|safe }};
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: categoryData.map(c => c.menu_item__category__name),
        datasets: [{
            label: 'Revenus (€)',
            data: categoryData.map(c => c.total_revenue),
            backgroundColor: 'rgba(13, 110, 253, 0.7)'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + ' €';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}